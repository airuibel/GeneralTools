#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2020/1/2 13:38
# @Author  : Cai
# @File    : makeTree.py
# @Note    : 构建kd_tree的过程
#            1. 针对连续型变量进行
#            2. 对数值进行归一化操作
#            3. tree_type = 1 ------------- ball_tree
#               tree_type = 0 ------------- kd_tree


import numpy as np
from sklearn.neighbors import KDTree, BallTree
import pickle
import sys
import pandas as pd


continuous_vars = ['ft_app_ins_current_finance_cnt_avg', 'ft_app_ins_current_finance_cnt_diff_m_llm', 'ft_app_ins_current_finance_cnt_diff_m_lm', 'ft_app_ins_current_finance_cnt_std', 'ft_app_ins_current_micro_loan_cnt_avg', 'ft_app_ins_current_micro_loan_cnt_diff_m_llm', 'ft_app_ins_current_micro_loan_cnt_diff_m_lm', 'ft_app_ins_current_micro_loan_cnt_std', 'ft_app_ins_current_finance_cnt_m_rate', 'ft_app_ins_current_debit_credit_cnt_m_rate', 'ft_app_ins_current_micro_loan_cnt_m_rate', 'ft_app_act_30d_finance_cnt_m_rate', 'ft_app_act_30d_finance_times_m_rate', 'ft_app_act_30d_finance_days_m_rate', 'ft_app_act_30d_debit_credit_cnt_m_rate', 'ft_app_act_30d_debit_credit_times_m_rate', 'ft_app_act_30d_debit_credit_days_m_rate', 'ft_app_act_30d_micro_loan_cnt_m_rate', 'ft_app_act_30d_micro_loan_times_m_rate', 'ft_app_act_30d_micro_loan_days_m_rate', 'ft_app_ins_current_finance_cnt_cv', 'ft_app_ins_current_debit_credit_cnt_cv', 'ft_app_ins_current_micro_loan_cnt_cv', 'ft_app_act_30d_finance_cnt_cv', 'ft_app_act_30d_finance_times_cv', 'ft_app_act_30d_finance_days_cv', 'ft_app_act_30d_debit_credit_cnt_cv', 'ft_app_act_30d_debit_credit_times_cv', 'ft_app_act_30d_debit_credit_days_cv', 'ft_app_act_30d_micro_loan_cnt_cv', 'ft_app_act_30d_micro_loan_times_cv', 'ft_app_act_30d_micro_loan_days_cv', 'ft_app_ins_current_risk_cnt', 'ft_app_ins_history_risk_cnt', 'ft_app_ins_current_cheating_cnt', 'ft_app_ins_history_cheating_cnt', 'ft_app_ins_current_imei_alter_cnt', 'ft_app_ins_history_imei_alter_cnt', 'ft_app_ins_current_malicious_cnt', 'ft_app_ins_history_malicious_cnt', 'ft_dev_battery_use_30d_whole_nighttime_hours', 'ft_dev_battery_use_30d_weekday_allday_hours', 'ft_dev_battery_use_30d_weekday_worktime_hours', 'ft_dev_battery_use_30d_weekday_closetime_hours', 'ft_dev_battery_use_30d_weekday_nighttime_hours', 'ft_dev_battery_use_30d_weekend_allday_hours', 'ft_dev_battery_all_90d_whole_allday_hours', 'ft_dev_battery_full_90d_whole_allday_hours', 'ft_dev_battery_full_90d_weekday_allday_hours', 'ft_dev_battery_full_90d_weekend_allday_hours', 'ft_dev_battery_charge_90d_whole_allday_hours', 'ft_dev_battery_charge_90d_weekday_allday_hours', 'ft_dev_battery_charge_90d_weekend_allday_hours', 'ft_dev_battery_use_90d_whole_allday_hours', 'ft_dev_battery_use_90d_whole_worktime_hours', 'ft_dev_battery_use_90d_whole_closetime_hours', 'ft_dev_battery_use_90d_whole_nighttime_hours', 'ft_dev_battery_use_90d_weekday_allday_hours', 'ft_dev_battery_use_90d_weekday_worktime_hours', 'ft_dev_battery_use_90d_weekday_closetime_hours', 'ft_dev_battery_use_90d_weekday_nighttime_hours', 'ft_dev_battery_use_90d_weekend_allday_hours', 'ft_dev_ip_30d_whole_allday_cnt', 'ft_dev_wifimac_30d_whole_allday_cnt', 'ft_dev_wifimac_30d_whole_allday_days', 'ft_dev_ip_30d_whole_worktime_cnt', 'ft_dev_ip_30d_whole_closetime_cnt', 'ft_dev_ip_30d_whole_nighttime_cnt', 'ft_dev_ip_30d_weekday_allday_cnt', 'ft_dev_ip_30d_weekday_worktime_cnt', 'ft_dev_ip_30d_weekday_closetime_cnt', 'ft_dev_ip_30d_weekday_nighttime_cnt', 'ft_dev_ip_30d_weekend_allday_cnt', 'ft_dev_wifimac_30d_whole_worktime_cnt', 'ft_dev_wifimac_30d_whole_closetime_cnt', 'ft_dev_wifimac_30d_whole_nighttime_cnt', 'ft_dev_wifimac_30d_weekday_allday_cnt', 'ft_dev_wifimac_30d_weekday_worktime_cnt', 'ft_dev_wifimac_30d_weekday_closetime_cnt', 'ft_dev_wifimac_30d_weekday_nighttime_cnt', 'ft_dev_wifimac_30d_weekend_allday_cnt', 'ft_dev_wifimac_30d_whole_worktime_days', 'ft_dev_wifimac_30d_whole_closetime_days', 'ft_dev_wifimac_30d_whole_nighttime_days', 'ft_dev_wifimac_30d_weekday_allday_days', 'ft_dev_wifimac_30d_weekday_worktime_days', 'ft_dev_wifimac_30d_weekday_closetime_days', 'ft_dev_wifimac_30d_weekday_nighttime_days', 'ft_dev_wifimac_30d_weekend_allday_days', 'ft_act_2week_rest_active_period_ls_hour0_4', 'ft_act_2week_rest_active_period_ls_hour12_13', 'ft_act_2week_rest_active_period_ls_hour13_18', 'ft_act_2week_rest_active_period_ls_hour18_23', 'ft_act_2week_rest_active_period_ls_hour5_7', 'ft_act_2week_rest_active_period_ls_hour8_11', 'ft_act_2week_work_active_period_ls_hour0_4', 'ft_act_2week_work_active_period_ls_hour12_13', 'ft_act_2week_work_active_period_ls_hour13_18', 'ft_act_2week_work_active_period_ls_hour18_23', 'ft_act_2week_work_active_period_ls_hour5_7', 'ft_act_2week_work_active_period_ls_hour8_11', 'ft_act_2week_rest_less_act_times', 'ft_act_2week_rest_most_act_times', 'ft_act_2week_rest_sum_act_times', 'ft_act_2week_work_less_act_times', 'ft_act_2week_work_most_act_times', 'ft_act_2week_work_sum_act_times', 'ft_app_act_30d_allcate_cnt', 'ft_app_act_30d_allcate_times', 'ft_app_act_30d_allcate_days', 'ft_app_act_30d_fitness_cnt', 'ft_app_act_30d_fitness_times', 'ft_app_act_30d_fitness_days', 'ft_app_act_30d_office_business_cnt', 'ft_app_act_30d_office_business_times', 'ft_app_act_30d_office_business_days', 'ft_app_act_30d_video_cnt', 'ft_app_act_30d_video_times', 'ft_app_act_30d_video_days', 'ft_app_act_30d_photo_cnt', 'ft_app_act_30d_insurance_cnt', 'ft_app_act_30d_insurance_times', 'ft_app_act_30d_insurance_days', 'ft_app_act_30d_credit_card_cnt', 'ft_app_act_30d_credit_card_times', 'ft_app_act_30d_credit_card_days', 'ft_app_act_30d_debit_credit_cnt', 'ft_app_act_30d_debit_credit_times', 'ft_app_act_30d_debit_credit_days', 'ft_app_act_30d_lottery_cnt', 'ft_app_act_30d_lottery_times', 'ft_app_act_30d_lottery_days', 'ft_app_act_30d_invest_cnt', 'ft_app_act_30d_invest_times', 'ft_app_act_30d_invest_days', 'ft_app_act_30d_payment_cnt', 'ft_app_act_30d_payment_times', 'ft_app_act_30d_payment_days', 'ft_app_act_30d_money_management_cnt', 'ft_app_act_30d_money_management_times', 'ft_app_act_30d_money_management_days', 'ft_app_act_30d_tally_cnt', 'ft_app_act_30d_tally_times', 'ft_app_act_30d_tally_days', 'ft_app_act_30d_bank_cnt', 'ft_app_act_30d_bank_times', 'ft_app_act_30d_bank_days', 'ft_app_act_30d_online_gamble_cnt', 'ft_app_act_30d_online_gamble_times', 'ft_app_act_30d_online_gamble_days', 'ft_app_act_30d_micro_loan_cnt', 'ft_app_act_30d_micro_loan_times', 'ft_app_act_30d_micro_loan_days', 'ft_app_act_30d_finance_cnt', 'ft_app_act_30d_finance_times', 'ft_app_act_30d_finance_days', 'ft_finance_score_c', 'ft_finance_score_d', 'ft_finance_score_e', 'ft_finance_score_f', 'ft_app_ins_current_gpscheat_cnt', 'ft_app_ins_history_gpscheat_cnt', 'ft_app_ins_current_simulator_cnt', 'ft_app_ins_history_simulator_cnt', 'ft_app_act_30d_risk_cnt', 'ft_app_act_30d_risk_times', 'ft_app_act_30d_risk_days', 'ft_app_act_30d_cheating_cnt', 'ft_app_act_30d_cheating_times', 'ft_app_act_30d_cheating_days', 'ft_app_act_30d_imei_alter_cnt', 'ft_app_act_30d_imei_alter_times', 'ft_app_act_30d_imei_alter_days', 'ft_app_act_30d_malicious_cnt', 'ft_app_act_30d_malicious_times', 'ft_app_act_30d_malicious_days', 'ft_app_act_30d_gpscheat_cnt', 'ft_app_act_30d_gpscheat_times', 'ft_app_act_30d_gpscheat_days', 'ft_app_act_30d_simulator_cnt', 'ft_app_act_30d_simulator_times', 'ft_app_act_30d_simulator_days', 'ft_gezhen_multi_loan_score', 'ft_safe_score_c', 'ft_safe_score_d', 'ft_safe_score_e', 'ft_safe_score_f', 'ft_dev_battery_full_30d_whole_allday_hours', 'ft_dev_battery_charge_30d_whole_allday_hours', 'ft_dev_battery_use_30d_whole_allday_hours', 'ft_dev_battery_all_30d_whole_allday_hours', 'ft_dev_battery_full_30d_weekday_allday_hours', 'ft_dev_battery_full_30d_weekend_allday_hours', 'ft_dev_battery_charge_30d_weekday_allday_hours', 'ft_dev_battery_charge_30d_weekend_allday_hours', 'ft_dev_battery_use_30d_whole_worktime_hours', 'ft_dev_battery_use_30d_whole_closetime_hours', 'ft_app_ins_current_money_management_cnt', 'ft_app_ins_history_money_management_cnt', 'ft_app_ins_current_tally_cnt', 'ft_app_ins_history_tally_cnt', 'ft_app_ins_current_bank_cnt', 'ft_app_ins_history_bank_cnt', 'ft_app_ins_current_online_gamble_cnt', 'ft_app_ins_history_online_gamble_cnt', 'ft_app_ins_current_micro_loan_cnt', 'ft_app_ins_history_micro_loan_cnt', 'ft_app_ins_history_shortterm_loan', 'ft_app_ins_current_shortterm_loan', 'ft_app_act_30d_gamble_cnt', 'ft_app_act_30d_gamble_times', 'ft_app_act_30d_gamble_days', 'ft_act_month_rest_active_period_ls_hour0_4', 'ft_act_month_rest_active_period_ls_hour12_13', 'ft_act_month_rest_active_period_ls_hour13_18', 'ft_act_month_rest_active_period_ls_hour18_23', 'ft_act_month_rest_active_period_ls_hour5_7', 'ft_act_month_rest_active_period_ls_hour8_11', 'ft_act_month_rest_less_act_times', 'ft_act_month_rest_most_act_times', 'ft_act_month_rest_sum_act_times', 'ft_act_month_work_active_period_ls_hour0_4', 'ft_act_month_work_active_period_ls_hour8_11', 'ft_act_month_work_active_period_ls_hour12_13', 'ft_act_month_work_active_period_ls_hour13_18', 'ft_act_month_work_active_period_ls_hour18_23', 'ft_act_month_work_active_period_ls_hour5_7', 'ft_act_month_work_less_act_times', 'ft_act_month_work_most_act_times', 'ft_act_month_work_sum_act_times', 'ft_app_ins_current_fitness_cnt', 'ft_app_ins_history_fitness_cnt', 'ft_app_ins_current_photo_cnt', 'ft_app_ins_history_photo_cnt', 'ft_app_ins_current_life_casual_cnt', 'ft_app_ins_history_life_casual_cnt', 'ft_app_ins_current_office_business_cnt', 'ft_app_ins_history_office_business_cnt', 'ft_app_ins_current_video_cnt', 'ft_app_ins_history_video_cnt', 'ft_app_ins_current_news_reading_cnt', 'ft_app_ins_history_news_reading_cnt', 'ft_app_ins_current_game_cnt', 'ft_app_ins_history_game_cnt', 'ft_app_ins_current_examination_cnt', 'ft_app_ins_history_examination_cnt', 'ft_app_ins_current_child_rearing_cnt', 'ft_app_ins_history_child_rearin_cnt', 'ft_app_ins_current_messaging_social_cnt', 'ft_app_ins_history_messaging_social_cnt', 'ft_app_ins_current_short_video_cnt', 'ft_app_ins_history_short_video_cnt', 'ft_app_ins_current_live_cnt', 'ft_app_ins_history_live_cnt', 'ft_act_cate_num', 'ft_act_max_act_time', 'ft_act_pkg_num', 'ft_ins_cate_app_cnt_ls_100000', 'ft_ins_cate_app_cnt_ls_120000', 'ft_ins_cate_app_cnt_ls_130000', 'ft_ins_cate_app_cnt_ls_140000', 'ft_ins_cate_app_cnt_ls_150000', 'ft_ins_cate_app_cnt_ls_160000', 'ft_ins_cate_app_cnt_ls_170000', 'ft_ins_cate_app_cnt_ls_190000', 'ft_ins_cate_app_cnt_ls_200000', 'ft_ins_cate_app_cnt_ls_210000', 'ft_ins_cate_app_cnt_ls_220000', 'ft_ins_cate_app_cnt_ls_230000', 'ft_ins_cate_app_cnt_ls_240000', 'ft_ins_cate_app_cnt_ls_250000', 'ft_ins_cate_app_cnt_ls_270000', 'ft_ins_cate_app_cnt_ls_290000', 'ft_ins_cate_app_cnt_ls_300000', 'ft_ins_cate_app_cnt_ls_900400', 'ft_ins_cate_app_cnt_ls_900500', 'ft_ins_cate_app_cnt_ls_900600', 'ft_ins_cate_app_cnt_ls_900700', 'ft_ins_category_cnt', 'ft_ins_largest_cate_cnt', 'ft_ins_pkg_cnt', 'ft_lbs_city_stay_oneday_cnt', 'ft_lbs_city_stay_twoday_cnt', 'ft_stable_score_a', 'ft_stable_score_c', 'ft_stable_score_e', 'ft_app_act_30d_debit_credit_cnt_avg', 'ft_app_act_30d_debit_credit_cnt_diff_m_llm', 'ft_app_act_30d_debit_credit_cnt_diff_m_lm', 'ft_app_act_30d_debit_credit_cnt_std', 'ft_app_act_30d_debit_credit_days_avg', 'ft_app_act_30d_debit_credit_days_diff_m_llm', 'ft_app_act_30d_debit_credit_days_diff_m_lm', 'ft_app_act_30d_debit_credit_days_std', 'ft_app_act_30d_debit_credit_times_avg', 'ft_app_act_30d_debit_credit_times_diff_m_llm', 'ft_app_act_30d_debit_credit_times_diff_m_lm', 'ft_app_act_30d_debit_credit_times_std', 'ft_app_act_30d_finance_cnt_avg', 'ft_app_act_30d_finance_cnt_diff_m_llm', 'ft_app_act_30d_finance_cnt_diff_m_lm', 'ft_app_act_30d_finance_cnt_std', 'ft_app_act_30d_finance_days_avg', 'ft_app_act_30d_finance_days_diff_m_llm', 'ft_app_act_30d_finance_days_diff_m_lm', 'ft_app_act_30d_finance_days_std', 'ft_app_act_30d_finance_times_avg', 'ft_app_act_30d_finance_times_diff_m_llm', 'ft_app_act_30d_finance_times_diff_m_lm', 'ft_app_act_30d_finance_times_std', 'ft_app_act_30d_micro_loan_cnt_avg', 'ft_app_act_30d_micro_loan_cnt_diff_m_llm', 'ft_app_act_30d_micro_loan_cnt_diff_m_lm', 'ft_app_act_30d_micro_loan_cnt_std', 'ft_app_act_30d_micro_loan_days_avg', 'ft_app_act_30d_micro_loan_days_diff_m_llm', 'ft_app_act_30d_micro_loan_days_diff_m_lm', 'ft_app_act_30d_micro_loan_days_std', 'ft_app_act_30d_micro_loan_times_avg', 'ft_app_act_30d_micro_loan_times_diff_m_llm', 'ft_app_act_30d_micro_loan_times_diff_m_lm', 'ft_app_act_30d_micro_loan_times_std', 'ft_app_ins_current_debit_credit_cnt_avg', 'ft_app_ins_current_debit_credit_cnt_diff_m_llm', 'ft_app_ins_current_debit_credit_cnt_diff_m_lm', 'ft_app_ins_current_debit_credit_cnt_std', 'ft_app_act_30d_market_days', 'ft_app_ins_current_online_shopping_cnt', 'ft_app_ins_history_online_shopping_cnt', 'ft_app_ins_current_travel_cnt', 'ft_app_ins_history_travel_cnt', 'ft_app_ins_current_discounts_cnt', 'ft_app_ins_history_discounts_cnt', 'ft_app_ins_current_market_cnt', 'ft_app_ins_history_market_cnt', 'ft_lbs_home_cons_ls_high', 'ft_lbs_home_cons_ls_low', 'ft_lbs_home_cons_ls_middle', 'ft_lbs_pwoi_all_mostoften_consume_high', 'ft_lbs_pwoi_all_mostoften_consume_low', 'ft_lbs_pwoi_all_mostoften_consume_middle', 'ft_lbs_pwoi_all_often_consum_high', 'ft_lbs_pwoi_all_often_consum_low', 'ft_lbs_pwoi_all_often_consum_middle', 'ft_lbs_work_cons_ls_high', 'ft_lbs_work_cons_ls_low', 'ft_lbs_work_cons_ls_middle', 'ft_consumption_score_a', 'ft_consumption_score_c', 'ft_consumption_score_e', 'ft_app_ins_current_finance_cnt', 'ft_app_ins_history_finance_cnt', 'ft_app_ins_current_gamble_cnt', 'ft_app_ins_history_gamble_cnt', 'ft_app_ins_current_insurance_cnt', 'ft_app_ins_history_insurance_cnt', 'ft_app_ins_current_credit_card_cnt', 'ft_app_ins_history_credit_card_cnt', 'ft_app_ins_current_debit_credit_cnt', 'ft_app_ins_history_debit_credit_cnt', 'ft_app_ins_current_lottery_cnt', 'ft_app_ins_history_lottery_cnt', 'ft_app_ins_current_invest_cnt', 'ft_app_ins_history_invest_cnt', 'ft_app_ins_current_payment_cnt', 'ft_app_ins_history_payment_cnt', 'ft_app_act_30d_photo_times', 'ft_app_act_30d_photo_days', 'ft_app_act_30d_news_reading_cnt', 'ft_app_act_30d_news_reading_times', 'ft_app_act_30d_news_reading_days', 'ft_app_act_30d_game_cnt', 'ft_app_act_30d_game_times', 'ft_app_act_30d_game_days', 'ft_app_act_30d_life_casual_cnt', 'ft_app_act_30d_life_casual_times', 'ft_app_act_30d_life_casual_days', 'ft_app_act_30d_examination_cnt', 'ft_app_act_30d_examination_times', 'ft_app_act_30d_examination_days', 'ft_app_act_30d_child_rearin_cnt', 'ft_app_act_30d_child_rearin_times', 'ft_app_act_30d_child_rearin_days', 'ft_app_act_30d_messaging_social_cnt', 'ft_app_act_30d_messaging_social_times', 'ft_app_act_30d_messaging_social_days', 'ft_app_act_30d_short_video_cnt', 'ft_app_act_30d_short_video_times', 'ft_app_act_30d_short_video_days', 'ft_app_act_30d_live_cnt', 'ft_app_act_30d_live_times', 'ft_app_act_30d_live_days', 'ft_asset_score_a', 'ft_asset_score_c', 'ft_asset_score_e', 'ft_app_act_30d_online_shopping_cnt', 'ft_app_act_30d_online_shopping_times', 'ft_app_act_30d_online_shopping_days', 'ft_app_act_30d_travel_cnt', 'ft_app_act_30d_travel_times', 'ft_app_act_30d_travel_days', 'ft_app_act_30d_discounts_cnt', 'ft_app_act_30d_discounts_times', 'ft_app_act_30d_discounts_days', 'ft_app_act_30d_market_cnt', 'ft_app_act_30d_market_times', 'ft_dev_storage', 'ft_dev_storage_usage_ratio', 'ft_dev_free_storage']

class MakeTree(object):
    def __init__(self, df, tree_type=None):
        self.df = df[continuous_vars]
        if tree_type is None:
            if len(df.columns) > 30:
                self.tree_type = 1
            else:
                self.tree_type = 0
        else:
            self.tree_type = tree_type
        self.data_trans_dict = {}

    def get_data_std(self):
        data_trans = self.df.copy()
        for col in continuous_vars:
            self.df[col] = self.df[col].astype(float)
            m, s = (np.mean(self.df[~self.df[col].isnull()][col].tolist()), np.std(self.df[~self.df[col].isnull()][col].tolist()))
            data_trans.loc[self.df[~self.df[col].isnull()].index, col] = data_trans[col].map(lambda x: round((x - m)/s, 2))
            data_trans[col] = data_trans[col].fillna(-1)
            self.data_trans_dict[col] = (s, m)
        self.save_file(self.data_trans_dict, "std_data.json")
        return data_trans

    def get_tree(self, df):
        if self.tree_type:
            tree = BallTree(df)
            self.save_file(tree, 'ball_tree.pkl')
            print("The ball_tree has been finished, the save_path is{}".format('ball_tree.pkl'))
        else:
            tree = KDTree(df)
            self.save_file(tree, 'kd_tree.pkl')
            print("The ball_tree has been finished, the save_path is{}".format('kd_tree.pkl'))

    def save_file(self, model, file_name):
        fw = open(file_name, 'wb')
        pickle.dump(model, fw, -1)
        fw.close()


if __name__ == '__main__':
    # file_path = sys.argv[1]
    file_path = "/Users/cai/Desktop/工作projects/202001 营销/kd_tree/ft_605_example.txt"
    df = pd.read_csv(file_path, sep="|")
    mt = MakeTree(df)
    std_df = mt.get_data_std()
    mt.get_tree(std_df)




